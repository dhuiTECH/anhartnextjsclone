# FULL DEPLOY: ADMIN (RBAC-SECURE + SEO BLOG) + MEMBER (FILES) + 2 BLOG UPDATES
# Your profiles table is perfect — this will use it for admin checks

# === 1. ADMIN LOGIN (Supabase Auth) ===
cat > pages/admin-login.jsx << 'EOF'
import { useState } from 'react';
import { supabase } from '../lib/supabase';
import { useRouter } from 'next/router';

export default function AdminLogin() {
  const [email, setEmail] = useState('damon.hui@anhart.ca'); // Pre-fill for testing
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const router = useRouter();

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    setLoading(false);
    if (!error) router.push('/admin/dashboard');
    else alert('Login failed: ' + error.message);
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
      <form onSubmit={handleLogin} className="p-10 bg-white rounded-xl shadow-lg w-full max-w-md">
        <h1 className="text-3xl font-bold text-center mb-8 text-indigo-700">Admin Login</h1>
        <input
          type="email"
          placeholder="Email (e.g., damon.hui@anhart.ca)"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500"
          required
        />
        <input
          type="password"
          placeholder="Password"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
          className="w-full p-3 border border-gray-300 rounded-lg mb-6 focus:ring-2 focus:ring-indigo-500"
          required
        />
        <button
          type="submit"
          disabled={loading}
          className="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition"
        >
          {loading ? 'Signing in...' : 'Enter Admin Panel'}
        </button>
      </form>
    </div>
  );
}
EOF

# === 2. ADMIN DASHBOARD: RBAC CHECK + SEO-OPTIMIZED PUBLISHER + TIPTAP ===
cat > pages/admin/dashboard.jsx << 'EOF'
import { useEffect, useState } from 'react';
import { supabase } from '../../lib/supabase';
import { useRouter } from 'next/router';
import { EditorContent, useEditor } from '@tiptap/react';
import StarterKit from '@tiptap/starter-kit';
import Link from '@tiptap/extension-link';
import Image from '@tiptap/extension-image';

export default function AdminDashboard() {
  const [user, setUser] = useState(null);
  const [title, setTitle] = useState('');
  const [meta, setMeta] = useState('');
  const [image, setImage] = useState('');
  const [loading, setLoading] = useState(false);
  const router = useRouter();

  const editor = useEditor({
    extensions: [StarterKit, Link, Image],
    content: '<p>Start writing your SEO-optimized article here...</p>',
  });

  useEffect(() => { checkAuth(); }, []);

  async function checkAuth() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return router.push('/admin-login');

    const { data: profile, error } = await supabase
      .from('profiles')
      .select('role, email')
      .eq('id', user.id)
      .single();

    if (error || profile?.role !== 'admin') {
      console.error('Admin check failed:', error);
      alert('Access denied: Admin role required in profiles table.');
      return supabase.auth.signOut().then(() => router.push('/'));
    }

    setUser(profile); // Use profile data for display
  }

  const slugify = (text) => text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');

  const publish = async (e) => {
    e.preventDefault();
    setLoading(true);
    const body = editor.getHTML();
    const slug = slugify(title);

    const { error } = await supabase.from('posts').insert({
      title,
      slug,
      meta_description: meta,
      featured_image_url: image,
      body,
      published: true,
      author_id: user.id,
      seo: { // Full SEO object for frontend rendering
        title,
        description: meta,
        og_image: image || 'https://anhart.ca/default-og.jpg',
        canonical: `https://anhart.ca/blog/${slug}`
      },
      created_at: new Date().toISOString(),
    });

    setLoading(false);
    if (error) alert('Publish error: ' + error.message);
    else {
      alert(`Published! View at: /blog/${slug}`);
      setTitle(''); setMeta(''); setImage(''); editor.commands.clearContent();
    }
  };

  if (!user) return <div className="min-h-screen flex items-center justify-center">Loading...</div>;

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-6">
      <div className="max-w-5xl mx-auto">
        <div className="bg-white rounded-xl shadow-lg p-8 mb-6">
          <h1 className="text-4xl font-bold text-indigo-700 mb-2">Admin Dashboard</h1>
          <p className="text-gray-600">Logged in as: {user.email} (Admin Role Verified)</p>
        </div>

        <form onSubmit={publish} className="bg-white rounded-xl shadow-lg p-8 space-y-6">
          <input
            type="text"
            placeholder="SEO Title (H1 + Page Title, 50-60 chars)"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            className="w-full text-2xl font-semibold p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500"
            required
          />
          <input
            type="text"
            placeholder="Meta Description (150-160 chars for SEO)"
            value={meta}
            onChange={(e) => setMeta(e.target.value)}
            maxLength="160"
            className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
          />
          <input
            type="url"
            placeholder="Featured Image URL (1200x630px for OG Images)"
            value={image}
            onChange={(e) => setImage(e.target.value)}
            className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-yellow-500"
          />

          <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 min-h-96 bg-gray-50">
            <EditorContent editor={editor} className="prose prose-lg max-w-none p-4" />
          </div>

          <div className="flex justify-end gap-4">
            <button
              type="button"
              onClick={() => supabase.auth.signOut().then(() => router.push('/'))}
              className="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
            >
              Logout
            </button>
            <button
              type="submit"
              disabled={loading}
              className="px-8 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition"
            >
              {loading ? 'Publishing...' : 'Publish SEO Article'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
EOF

# === 3. MEMBER DASHBOARD: PROTECTED FILE ACCESS ===
cat > pages/member/dashboard.jsx << 'EOF'
import { useEffect, useState } from 'react';
import { supabase } from '../../lib/supabase';
import { useRouter } from 'next/router';

export default function MemberDashboard() {
  const [user, setUser] = useState(null);
  const [files, setFiles] = useState([]);
  const [loading, setLoading] = useState(true);
  const router = useRouter();

  useEffect(() => { checkAuth(); }, []);

  async function checkAuth() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return router.push('/login'); // Or your member login

    // Optional: Check role !== 'admin' to redirect admins elsewhere
    const { data: profile } = await supabase.from('profiles').select('role').eq('id', user.id).single();
    if (profile?.role === 'admin') return router.push('/admin/dashboard');

    setUser(user);
    loadFiles();
    setLoading(false);
  }

  async function loadFiles() {
    const { data, error } = await supabase.storage.from('member-files').list('', { limit: 100 });
    if (!error) setFiles(data?.filter(f => !f.name.startsWith('.')) || []);
  }

  const downloadFile = (fileName) => {
    const { data } = supabase.storage.from('member-files').getPublicUrl(fileName);
    if (data.publicUrl) window.open(data.publicUrl, '_blank');
  };

  if (loading) return <div className="min-h-screen flex items-center justify-center">Loading...</div>;
  if (!user) return null;

  return (
    <div className="min-h-screen bg-gradient-to-br from-teal-50 to-cyan-100 p-6">
      <div className="max-w-4xl mx-auto">
        <div className="bg-white rounded-xl shadow-lg p-8 mb-6">
          <h1 className="text-3xl font-bold text-teal-700 mb-2">Member Portal</h1>
          <p className="text-gray-600">Welcome, {user.email}!</p>
        </div>

        <div className="bg-white rounded-xl shadow-lg p-8">
          <h2 className="text-2xl font-semibold text-teal-600 mb-6">Private Files Access</h2>
          {files.length === 0 ? (
            <p className="text-gray-500 italic">No files uploaded yet. Check back soon!</p>
          ) : (
            <div className="grid gap-4">
              {files.map((file) => (
                <div
                  key={file.name}
                  onClick={() => downloadFile(file.name)}
                  className="flex items-center justify-between p-4 border rounded-lg hover:bg-teal-50 cursor-pointer transition"
                >
                  <div className="flex items-center gap-3">
                    <svg className="w-6 h-6 text-teal-600" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V8a2 2 0 00-2-2h-5L9 4H4zm0 2h5l1.586 1.586a1 1 0 00.707.293H16v6H4V6z" />
                    </svg>
                    <span className="font-medium text-gray-800">{file.name}</span>
                  </div>
                  <span className="text-sm text-gray-500">Click to download</span>
                </div>
              ))}
            </div>
          )}
        </div>

        <div className="mt-6 text-center">
          <button
            onClick={() => supabase.auth.signOut().then(() => router.push('/'))}
            className="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
          >
            Logout
          </button>
        </div>
      </div>
    </div>
  );
}
EOF

# === 4. UPDATE YOUR 2 EXISTING BLOG POSTS (Clean Markdown + Real BC Housing Links) ===
# Run this Node script (assumes your .env has SUPABASE_URL and SUPABASE_ANON_KEY)
cat > update-blogs.js << 'EOF'
const { createClient } = require('@supabase/supabase-js');
const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_ANON_KEY);

// Modular Housing Post (Full Clean Version)
const modularBody = `
### The Future is Built in a Factory
Canada is facing a profound housing crisis. As costs for traditional construction soar and the demand for affordable units far outpaces supply, we must turn to innovation. At the forefront of this change is **modular housing**, a revolutionary construction method that is poised to redefine our approach to building communities.

But what is modular housing? Simply put, it's a process where homes are built in sections (or "modules") in a controlled, factory environment. These modules—complete with walls, flooring, plumbing, and electrical—are then transported to the building site, where they are assembled into a complete structure. This isn't the "prefab" of decades past; today's modular construction is **high-quality, sustainable, customizable, and incredibly efficient**.

#### 1. Speed: Getting People into Homes Faster
The most significant advantage of modular construction is **speed**. A traditional site-built project is linear: you can't start framing until the foundation is cured. Modular construction is a **parallel process**.

- **Parallel Work:** While the modules are being precision-built in the factory, the on-site team is simultaneously excavating, laying the foundation, and preparing utilities.  
- **No Weather Delays:** Building indoors eliminates 100% of weather-related delays—a massive factor in Canadian construction, where rain, snow, and cold can halt work for weeks.

This parallel process can cut the total construction timeline by **50% to 60%**. In a housing crisis, this speed is not just a convenience; it's a critical lifeline, allowing organizations like **Anhart** to deliver safe, permanent housing to communities in **months, not years**. The Government of Canada lists modular construction as a key part of its [National Housing Strategy](https://www.cmhc-schl.gc.ca/en/professionals/housing-markets-data-and-research/housing-research/insight-series/modular-construction).

#### 2. Cost: Making "Affordable" Truly Attainable
Modular construction attacks high costs from multiple angles, providing **cost predictability** that is rare in traditional builds.

- **Reduced Material Waste:** Factory precision means materials are cut and used with computer-aided accuracy, dramatically reducing the waste that is common on traditional job sites.  
- **Lower Labor Costs:** Fewer on-site hours and a more streamlined assembly process reduce the high cost of skilled labor, especially in expensive urban markets.  
- **Predictability:** Factory-built projects have fewer surprises. With 90% of the work done in a controlled setting, the risk of costly overruns and change orders plummets. This financial certainty is essential for non-profit developers managing fixed budgets.

#### 3. Quality & Durability: A Superior Product
Unlike the outdated stigma of the past, today's modular homes are **often higher quality** than site-built structures.

Each module is built to exacting standards in a quality-controlled environment, with **dozens of inspections** before it ever leaves the factory. They are built "inside-out," allowing for **superior insulation and air-sealing**. Furthermore, modules must be built to withstand the stresses of transportation, which often results in them being **more rigid and durable** than traditional stick-built frames. This leads to a tighter, more resilient building that **exceeds many site-built standards**.

#### 4. Sustainability: Building a Greener Future
The environmental benefits are clear.

- **Significant reduction in material waste** → less landfill.  
- **Factory process uses less energy**.  
- **Final product is a tighter, more energy-efficient building** → lower carbon footprint and lower long-term utility costs for residents.

This method aligns perfectly with Canada’s national goals for **net-zero housing**; see the [Canada Greener Homes Initiative](https://natural-resources.canada.ca/energy-efficiency/homes/canada-greener-homes-initiative/23441).

#### 5. Proof in Practice: Modular Housing in BC
This isn't just a theory; it's working in our communities. In recent years, **Vancouver and other BC municipalities** have embraced modular construction to create **hundreds of homes** for vulnerable residents, assembled on-site in **just days**. These projects demonstrate that high-performance, resilient modular housing can be delivered quickly, even in complex urban environments.

At **Anhart**, we see modular construction as a **critical tool** in our mission. It allows us to build and deliver new, safe, and supportive homes at a scale and speed that was previously impossible. It's not just about building houses; it's about **building a future where every Canadian has a place to call home**.
`;

// Subsidies Post (Full Clean Version)
const subsidiesBody = `
### A Guide to Affordable Rent in BC
For many individuals and families in British Columbia, finding **affordable, safe housing** can feel like an impossible task. As rents continue to rise, the gap between an average income and the cost of a home widens. This is where **housing subsidies** become a vital lifeline.

But what is a housing subsidy? In short, it's a **financial assistance program**, most often from the government, designed to help low-income households afford their rent. It **bridges the gap** between what a family can afford and the actual market rent.

#### The Primary Model: Rent-Geared-to-Income (RGI)
When most people talk about "social housing" or "subsidized housing," they are often referring to **Rent-Geared-to-Income (RGI)**.

**How it works:**  
With RGI, your rent is **not a fixed dollar amount**. Instead, it is calculated to be a **percentage of your household's total gross income** (typically **30%**).

**Why it matters:**  
This model provides **incredible stability**. If your income goes down one month (due to job loss or illness), your rent also goes down. If your income increases, your rent contribution increases, but it **never exceeds that 30% cap**. This ensures that you are not spending a disproportionate amount of your income on shelter, freeing up money for groceries, healthcare, and transportation. RGI is the **cornerstone of true housing affordability**.

#### Other Key Support Programs in BC
While RGI is the most comprehensive model, **BC Housing** also offers other forms of **rent supplement** assistance:

| Program | Who It Helps | Key Details |
|---------|--------------|-------------|
| **Rental Assistance Program (RAP)** | Low-income working families with children under 19 | Monthly cash subsidy for private-market rent. 2025 income limit: **$60,000** (varies by family size). [Apply here](https://www2.gov.bc.ca/gov/content/housing-tenancy/rental-assistance-programs/rental-assistance-program) |
| **Shelter Aid For Elderly Renters (SAFER)** | Seniors aged 60+ with low-to-moderate income | Cash subsidy for private-market rent. [Apply here](https://www2.gov.bc.ca/gov/content/housing-tenancy/rental-assistance-programs/safer) |
| **Affordable Rental** | General low-income tenants | Units (like many operated by **Anhart**) where rent is set **below market** but not tied to income. |

#### How Do I Qualify for Support?
Qualifying for subsidized housing in British Columbia typically depends on a few key factors:

1. **Household Income** – Must be below the **Housing Income Limit (HIL)** for your community (published annually by BC Housing).  
2. **Family Size** – Determines the unit size you qualify for.  
3. **Residency** – Canadian citizen, permanent resident, or refugee claimant.  
4. **Assets** – Generally under **$100,000** (varies by program).  
5. **Need** – Priority for seniors, people with disabilities, families with children, or those facing homelessness.

#### The First Step: The BC Housing Hub
Navigating these systems can be daunting, but there is a **central starting point**. The main portal for applying for **all forms of RGI** and many other subsidized housing options is **The Housing Registry**, operated by **BC Housing**.

- Submit **one application** (online or by mail) → entered into a **centralized waitlist**.  
- Makes you eligible for units managed by **BC Housing** *and* hundreds of non-profit partners—like **Anhart**—across the province.  

**Apply here:** [The Housing Registry](https://www.bchousing.org/housing-assistance/the-housing-registry)

When a unit becomes available, the housing provider contacts the next eligible applicant. Waitlists can be long, which is why organizations like ours are working hard to **build new supply**.

At **Anhart**, we work directly with **BC Housing** and other partners to provide units that are part of this critical system. We believe **everyone deserves a safe and affordable home**, and subsidies are a vital part of making that a reality.
`;

async function updatePosts() {
  // Update Modular Post
  const { error: modError } = await supabase
    .from('posts')
    .update({ body: modularBody })
    .eq('title', 'Modular Housing Solutions: The Future of Affordable Living in Canada');

  // Update Subsidies Post
  const { error: subError } = await supabase
    .from('posts')
    .update({ body: subsidiesBody })
    .eq('title', 'Understanding Housing Subsidies and Qualifying for Support in British Columbia');

  if (modError) console.error('Modular update error:', modError);
  else console.log('Modular post updated!');

  if (subError) console.error('Subsidies update error:', subError);
  else console.log('Subsidies post updated!');

  console.log('Blog updates complete.');
}

updatePosts();
EOF

# Run the updates (in your Replit Shell: node update-blogs.js)
echo "Run: node update-blogs.js" && echo "Then restart your dev server: npm run dev"

# Install Tiptap if missing (one-time)
npm install @tiptap/react @tiptap/starter-kit @tiptap/extension-link @tiptap/extension-image